---
- name: Generate Terraform variables from Ansible vault
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../../secrets/vault_vars.yml
  tasks:
    - name: Create Terraform variables file
      copy:
        content: |
          # Auto-generated by Ansible from vault secrets
          # DO NOT commit this file to git (it's in .gitignore)

          proxmox_api_url          = "https://njord.julianverse.net/api2/json"
          proxmox_api_token_id     = "{{ proxmox_terraform_token_id }}"
          proxmox_api_token_secret = "{{ proxmox_terraform_token_secret }}"
        dest: "{{ playbook_dir }}/../../terraform/terraform.tfvars"
        mode: '0600'

    - name: Confirm terraform.tfvars created
      debug:
        msg: "Terraform variables file created at {{ playbook_dir }}/../../terraform/terraform.tfvars"
