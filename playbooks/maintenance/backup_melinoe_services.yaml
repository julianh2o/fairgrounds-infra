---
- name: Backup melinoe services
  hosts: melinoe
  become: yes

  vars:
    backup_dir: /mnt/Store/Backups/melinoe-services
    timestamp: "{{ ansible_date_time.date }}-{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}{{ ansible_date_time.second }}"
    backup_file: "{{ backup_dir }}/melinoe-services-{{ timestamp }}.tar.gz"

  tasks:
    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Create tar.gz backup of /opt (excluding socket files)
      ansible.builtin.command:
        cmd: >
          tar --exclude='*.sock'
          --exclude='*ipc-socket*'
          --exclude='*.socket'
          --warning=no-file-changed
          --warning=no-file-removed
          -czf {{ backup_file }} -C /opt .
        creates: "{{ backup_file }}"
      register: tar_result
      changed_when: tar_result.rc == 0

    - name: Set backup file permissions
      ansible.builtin.file:
        path: "{{ backup_file }}"
        owner: root
        group: root
        mode: "0644"

    - name: Display backup location
      ansible.builtin.debug:
        msg: "Backup created at: {{ backup_file }}"
