- name: Deploy Grafana
  hosts: metis
  become: yes

  vars_files:
    - ../../secrets.yml

  vars:
    recreate: false

  pre_tasks:
    - name: Delete Grafana data directory (if recreate is enabled)
      ansible.builtin.file:
        path: /opt/grafana/data
        state: absent
      when: recreate | bool

  tasks:
    - name: Copy Grafana provisioning directory
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../grafana/provisioning/"
        dest: "/opt/grafana/provisioning/"
        owner: root
        group: root
        mode: "0755"

    - name: Copy Grafana dashboards directory
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../grafana/dashboards/"
        dest: "/opt/grafana/dashboards/"
        owner: root
        group: root
        mode: "0755"

  roles:
    - role: docker_service
      vars:
        service_name: grafana
        compose_template: grafana-compose.yml.j2
        config_files:
          - src: grafana.ini.j2
            dest: grafana.ini
        service_directories:
          - path: data
            mode: "0777"
        docker_compose_state: present
