#!/bin/bash

# formatDockerState - Parse docker state JSON and display container names with uptime
#
# Usage:
#   ./formatDockerState [file]              # Use specified file
#   ./formatDockerState                     # Use latest file in reports/docker/

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPORTS_DIR="$SCRIPT_DIR/../reports/docker"

# Determine which file to use
if [ $# -eq 0 ]; then
    # No argument provided, find the latest file
    if [ ! -d "$REPORTS_DIR" ]; then
        echo "Error: Reports directory not found: $REPORTS_DIR" >&2
        exit 1
    fi

    DOCKER_STATE_FILE=$(ls -t "$REPORTS_DIR"/*.json 2>/dev/null | head -1)

    if [ -z "$DOCKER_STATE_FILE" ]; then
        echo "Error: No JSON files found in $REPORTS_DIR" >&2
        exit 1
    fi
else
    DOCKER_STATE_FILE="$1"
    if [ ! -f "$DOCKER_STATE_FILE" ]; then
        echo "Error: File not found: $DOCKER_STATE_FILE" >&2
        exit 1
    fi
fi

# Check if jq is available
if ! command -v jq &> /dev/null; then
    echo "Error: jq is required but not installed. Install it with: sudo apt-get install jq" >&2
    exit 1
fi

# Parse and display the docker state
echo "Docker Container Status (from $(basename "$DOCKER_STATE_FILE"))"
echo "============================================"
echo ""

jq -r '.[] | "\(.Names)\t\(.Status)"' "$DOCKER_STATE_FILE" | column -t -s $'\t'
