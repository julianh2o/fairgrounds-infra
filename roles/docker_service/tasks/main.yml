---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - service_name is defined
      - service_name | length > 0
      - compose_template is defined
      - compose_template | length > 0
    fail_msg: "service_name and compose_template are required variables"
    quiet: yes

- name: Create base service directory
  ansible.builtin.file:
    path: "{{ service_base_dir }}"
    state: directory
    owner: "{{ service_owner }}"
    group: "{{ service_group }}"
    mode: "{{ service_dir_mode }}"

- name: Create additional service directories
  ansible.builtin.file:
    path: "{{ service_base_dir }}/{{ item.path | default(item) }}"
    state: directory
    owner: "{{ service_owner }}"
    group: "{{ service_group }}"
    mode: "{{ item.mode | default(service_dir_mode) }}"
  loop: "{{ service_directories }}"
  when: service_directories | length > 0

- name: Deploy docker-compose.yml
  ansible.builtin.template:
    src: "{{ inventory_dir }}/templates/{{ compose_template }}"
    dest: "{{ service_base_dir }}/docker-compose.yml"
    owner: "{{ service_owner }}"
    group: "{{ service_group }}"
    mode: "{{ service_file_mode }}"

- name: Deploy additional configuration files
  ansible.builtin.template:
    src: "{{ inventory_dir }}/templates/{{ item.src }}"
    dest: "{{ service_base_dir }}/{{ item.dest }}"
    owner: "{{ service_owner }}"
    group: "{{ service_group }}"
    mode: "{{ item.mode | default(service_file_mode) }}"
  loop: "{{ config_files }}"
  when: config_files | length > 0

- name: Stop and remove containers
  community.docker.docker_compose_v2:
    project_name: "{{ docker_compose_project_name }}"
    project_src: "{{ service_base_dir }}"
    state: absent
  when: docker_compose_state != "stopped"

- name: Pull latest Docker images
  ansible.builtin.command:
    cmd: docker compose pull
    chdir: "{{ service_base_dir }}"
  register: docker_pull_result
  changed_when: "'Pulled' in docker_pull_result.stdout or 'Pulling' in docker_pull_result.stdout"
  when: docker_compose_state != "stopped"

- name: Start containers
  community.docker.docker_compose_v2:
    project_name: "{{ docker_compose_project_name }}"
    project_src: "{{ service_base_dir }}"
    state: present
  when: docker_compose_state != "stopped"

- name: Stop containers (if requested)
  community.docker.docker_compose_v2:
    project_name: "{{ docker_compose_project_name }}"
    project_src: "{{ service_base_dir }}"
    state: stopped
  when: docker_compose_state == "stopped"
